{% extends "base.html" %}

{% block title %}Notifications - AI-AgroBot{% endblock %}

{% block extra_css %}
<style>
.notification-card {
    border-radius: 10px;
    transition: all 0.3s ease;
    border-left: 4px solid #198754;
}
.notification-card.unread {
    background-color: #e8f5e8;
    border-left-color: #198754;
}
.notification-card.important {
    border-left-color: #dc3545;
}
.notification-card.warning {
    border-left-color: #ffc107;
}
.notification-card.info {
    border-left-color: #0dcaf0;
}
.notification-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
}
.notification-time {
    font-size: 0.8rem;
}
.filter-badge {
    cursor: pointer;
    transition: all 0.3s ease;
}
.filter-badge.active {
    background-color: #198754;
    color: white;
}
.mark-all-read {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-success text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="display-5 fw-bold mb-3">Notifications</h1>
                            <p class="lead mb-0">Stay updated with important alerts and messages</p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="display-6 mb-2" id="unreadCount">12</div>
                            <small>Unread notifications</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge filter-badge active" data-filter="all">All</span>
                                <span class="badge filter-badge" data-filter="unread">Unread</span>
                                <span class="badge filter-badge" data-filter="weather">Weather</span>
                                <span class="badge filter-badge" data-filter="market">Market</span>
                                <span class="badge filter-badge" data-filter="pest">Pest Alerts</span>
                                <span class="badge filter-badge" data-filter="system">System</span>
                                <span class="badge filter-badge" data-filter="community">Community</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <button class="btn btn-outline-success" id="markAllRead">
                                <i class="bi bi-check-all me-2"></i>Mark All Read
                            </button>
                            <button class="btn btn-outline-danger ms-2" id="clearAll">
                                <i class="bi bi-trash me-2"></i>Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="row">
        <div class="col-lg-8">
            <div id="notificationsList">
                <!-- Notifications will be loaded here -->
            </div>

            <!-- Empty State -->
            <div class="text-center py-5 d-none" id="emptyState">
                <i class="bi bi-bell-slash display-1 text-muted mb-3"></i>
                <h4>No notifications</h4>
                <p class="text-muted">You're all caught up!</p>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Notification Settings -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Notification Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Email Notifications</h6>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="weatherEmail" checked>
                            <label class="form-check-label" for="weatherEmail">Weather alerts</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="marketEmail" checked>
                            <label class="form-check-label" for="marketEmail">Market updates</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="pestEmail">
                            <label class="form-check-label" for="pestEmail">Pest & disease alerts</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="systemEmail" checked>
                            <label class="form-check-label" for="systemEmail">System updates</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Push Notifications</h6>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="weatherPush" checked>
                            <label class="form-check-label" for="weatherPush">Urgent weather alerts</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="marketPush">
                            <label class="form-check-label" for="marketPush">Price alerts</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="communityPush" checked>
                            <label class="form-check-label" for="communityPush">Community replies</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Frequency</h6>
                        <select class="form-select">
                            <option value="instant">Instant</option>
                            <option value="hourly" selected>Hourly digest</option>
                            <option value="daily">Daily summary</option>
                            <option value="weekly">Weekly report</option>
                        </select>
                    </div>

                    <button class="btn btn-success w-100" id="saveSettings">
                        <i class="bi bi-save me-2"></i>Save Settings
                    </button>
                </div>
            </div>

            <!-- Important Alerts -->
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Important Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <h6 class="mb-1">Heavy Rain Alert</h6>
                        <p class="small mb-0">Heavy rainfall expected in 48 hours. Prepare irrigation accordingly.</p>
                        <small class="text-muted">From: Weather System</small>
                    </div>

                    <div class="alert alert-info mb-3">
                        <h6 class="mb-1">Market Price Spike</h6>
                        <p class="small mb-0">Wheat prices increased by 12% today. Consider selling.</p>
                        <small class="text-muted">From: Market Intelligence</small>
                    </div>

                    <div class="alert alert-success mb-0">
                        <h6 class="mb-1">Crop Health Update</h6>
                        <p class="small mb-0">Your wheat crop is at 85% health. No immediate action needed.</p>
                        <small class="text-muted">From: AI Analysis</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationTitle">Notification Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="notificationDetail">
                    <!-- Details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="actionButton">Take Action</button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="btn btn-success btn-lg mark-all-read shadow-lg" id="floatingMarkRead">
    <i class="bi bi-check-all me-2"></i>Mark All Read
</button>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Sample notifications data
    const notifications = [
        {
            id: 1,
            title: "Heavy Rainfall Alert",
            message: "Heavy rainfall expected in your region in 48 hours. Prepare drainage and delay irrigation.",
            type: "weather",
            priority: "high",
            read: false,
            timestamp: "10 minutes ago",
            icon: "bi-cloud-rain-heavy",
            color: "info",
            action: "weather"
        },
        {
            id: 2,
            title: "Wheat Price Increase",
            message: "Market prices for wheat have increased by 12% today. Consider selling your stock.",
            type: "market",
            priority: "medium",
            read: false,
            timestamp: "2 hours ago",
            icon: "bi-graph-up-arrow",
            color: "success",
            action: "market"
        },
        {
            id: 3,
            title: "Pest Alert: Aphids Detected",
            message: "High aphid activity reported in your area. Monitor your crops and apply neem oil if needed.",
            type: "pest",
            priority: "high",
            read: true,
            timestamp: "5 hours ago",
            icon: "bi-bug",
            color: "danger",
            action: "pest"
        },
        {
            id: 4,
            title: "Irrigation Reminder",
            message: "Time to water your wheat field. Best watering time: Tomorrow morning 6-8 AM.",
            type: "reminder",
            priority: "medium",
            read: false,
            timestamp: "1 day ago",
            icon: "bi-droplet",
            color: "primary",
            action: "schedule"
        },
        {
            id: 5,
            title: "System Update Available",
            message: "New AI-AgroBot update v2.5 is available with improved image analysis.",
            type: "system",
            priority: "low",
            read: true,
            timestamp: "2 days ago",
            icon: "bi-arrow-up-circle",
            color: "warning",
            action: "update"
        },
        {
            id: 6,
            title: "Community Reply",
            message: "Rajesh Kumar replied to your question about organic fertilizers.",
            type: "community",
            priority: "low",
            read: false,
            timestamp: "3 days ago",
            icon: "bi-people",
            color: "secondary",
            action: "community"
        },
        {
            id: 7,
            title: "Fertilizer Application Due",
            message: "Time to apply second dose of NPK fertilizer to your wheat crop.",
            type: "reminder",
            priority: "medium",
            read: true,
            timestamp: "4 days ago",
            icon: "bi-flower1",
            color: "success",
            action: "schedule"
        },
        {
            id: 8,
            title: "Weather: Temperature Drop",
            message: "Sudden temperature drop expected tonight. Protect sensitive crops.",
            type: "weather",
            priority: "medium",
            read: false,
            timestamp: "5 days ago",
            icon: "bi-thermometer-low",
            color: "info",
            action: "weather"
        }
    ];

    // Render notifications
    function renderNotifications(data) {
        const list = $('#notificationsList');
        const emptyState = $('#emptyState');

        if (data.length === 0) {
            list.empty();
            emptyState.removeClass('d-none');
            updateUnreadCount();
            return;
        }

        emptyState.addClass('d-none');
        list.empty();

        data.forEach(notification => {
            const priorityClass = notification.priority === 'high' ? 'important' :
                                notification.priority === 'medium' ? 'warning' : 'info';
            const readClass = notification.read ? '' : 'unread';

            const card = `
                <div class="card notification-card ${readClass} ${priorityClass} mb-3" data-id="${notification.id}">
                    <div class="card-body">
                        <div class="d-flex">
                            <div class="notification-icon ${getColorClass(notification.color)} me-3">
                                <i class="${notification.icon} fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="mb-1">${notification.title}</h6>
                                    <small class="text-muted notification-time">${notification.timestamp}</small>
                                </div>
                                <p class="mb-2">${notification.message}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge ${getTypeBadge(notification.type)}">${notification.type}</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success view-detail" data-id="${notification.id}">
                                            View Details
                                        </button>
                                        ${!notification.read ? `
                                        <button class="btn btn-sm btn-outline-secondary mark-read ms-2" data-id="${notification.id}">
                                            Mark Read
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            list.append(card);
        });

        updateUnreadCount();
    }

    // Helper functions
    function getColorClass(color) {
        const classes = {
            'success': 'bg-success bg-opacity-10 text-success',
            'danger': 'bg-danger bg-opacity-10 text-danger',
            'warning': 'bg-warning bg-opacity-10 text-warning',
            'info': 'bg-info bg-opacity-10 text-info',
            'primary': 'bg-primary bg-opacity-10 text-primary',
            'secondary': 'bg-secondary bg-opacity-10 text-secondary'
        };
        return classes[color] || 'bg-light text-dark';
    }

    function getTypeBadge(type) {
        const badges = {
            'weather': 'bg-info',
            'market': 'bg-success',
            'pest': 'bg-danger',
            'reminder': 'bg-warning',
            'system': 'bg-primary',
            'community': 'bg-secondary'
        };
        return badges[type] || 'bg-dark';
    }

    // Update unread count
    function updateUnreadCount() {
        const unreadCount = notifications.filter(n => !n.read).length;
        $('#unreadCount').text(unreadCount);
        $('#floatingMarkRead').toggle(unreadCount > 0);
    }

    // Filter notifications
    $('.filter-badge').click(function() {
        $('.filter-badge').removeClass('active');
        $(this).addClass('active');

        const filter = $(this).data('filter');
        let filtered = notifications;

        if (filter === 'unread') {
            filtered = notifications.filter(n => !n.read);
        } else if (filter !== 'all') {
            filtered = notifications.filter(n => n.type === filter);
        }

        filtered.sort((a, b) => {
            // Unread first, then by priority
            if (a.read !== b.read) return a.read ? 1 : -1;
            const priorityOrder = {high: 0, medium: 1, low: 2};
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        });

        renderNotifications(filtered);
    });

    // Mark as read
    $(document).on('click', '.mark-read', function() {
        const id = $(this).data('id');
        const notification = notifications.find(n => n.id === id);

        if (notification) {
            notification.read = true;
            $(this).closest('.notification-card').removeClass('unread');
            $(this).remove();
            updateUnreadCount();
        }
    });

    // Mark all as read
    $('#markAllRead').click(function() {
        notifications.forEach(n => n.read = true);
        $('.notification-card').removeClass('unread');
        $('.mark-read').remove();
        updateUnreadCount();
        showToast('All notifications marked as read');
    });

    $('#floatingMarkRead').click(function() {
        $('#markAllRead').click();
    });

    // Clear all
    $('#clearAll').click(function() {
        if (confirm('Clear all notifications? This action cannot be undone.')) {
            notifications.length = 0; // Clear array
            renderNotifications([]);
            showToast('All notifications cleared');
        }
    });

    // View detail
    $(document).on('click', '.view-detail', function() {
        const id = $(this).data('id');
        const notification = notifications.find(n => n.id === id);

        if (notification) {
            // Mark as read when viewing
            notification.read = true;
            $(this).closest('.notification-card').removeClass('unread');
            $(this).closest('.notification-card').find('.mark-read').remove();
            updateUnreadCount();

            $('#notificationTitle').text(notification.title);
            $('#notificationDetail').html(`
                <div class="text-center mb-4">
                    <div class="notification-icon ${getColorClass(notification.color)} mx-auto mb-3" style="width: 80px; height: 80px;">
                        <i class="${notification.icon} display-4"></i>
                    </div>
                    <h5>${notification.title}</h5>
                    <span class="badge ${getTypeBadge(notification.type)}">${notification.type}</span>
                </div>
                <p>${notification.message}</p>
                <div class="mt-4">
                    <small class="text-muted">Priority: <span class="text-${notification.priority === 'high' ? 'danger' : notification.priority === 'medium' ? 'warning' : 'success'}">${notification.priority}</span></small><br>
                    <small class="text-muted">Received: ${notification.timestamp}</small>
                </div>
            `);

            // Set action button
            const actionBtn = $('#actionButton');
            const actions = {
                'weather': {text: 'View Weather', url: '/weather'},
                'market': {text: 'Check Prices', url: '/market'},
                'pest': {text: 'View Pest Info', url: '/pest-database'},
                'schedule': {text: 'View Schedule', url: '/crop-planner'},
                'update': {text: 'Update Now', url: '#'},
                'community': {text: 'View Reply', url: '/community'}
            };

            const action = actions[notification.action];
            if (action) {
                actionBtn.text(action.text);
                actionBtn.off('click').on('click', function() {
                    if (action.url === '#') {
                        alert('Update feature coming soon!');
                    } else {
                        window.location.href = action.url;
                    }
                    $('#detailModal').modal('hide');
                });
                actionBtn.show();
            } else {
                actionBtn.hide();
            }

            $('#detailModal').modal('show');
        }
    });

    // Save settings
    $('#saveSettings').click(function() {
        showToast('Notification settings saved successfully!');
    });

    // Toast notification
    function showToast(message) {
        const toast = $(`
            <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `);

        $('.toast-container').remove();
        $('body').append('<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
        $('.toast-container').append(toast);

        const bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();
    }

    // Initialize
    renderNotifications(notifications);
});
</script>
{% endblock %}

